<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Giảng dạy THCS Nhon Hoi</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        * { -webkit-overflow-scrolling: touch; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            LayoutDashboard, Users, CalendarDays, FileText, Save, Settings, 
            Plus, Trash2, Edit3, Check, X, FileUp, Download, 
            ChevronLeft, ChevronRight, RefreshCw
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONSTANTS ---
        const STORAGE_KEY = 'thcs_teaching_mgmt_data';
        const DEFAULT_STANDARD_QUOTA = 19;
        const INITIAL_ROLES = [
            { id: '1', name: 'Tổ trưởng', reduction: 3 },
            { id: '2', name: 'Chủ nhiệm', reduction: 4 },
            { id: '3', name: 'Thư ký hội đồng', reduction: 2 },
            { id: '4', name: 'Tổ phó', reduction: 1 },
            { id: '5', name: 'Tổng phụ trách', reduction: 10 }
        ];

        // --- COMPONENTS ---

        // 1. ConfigTab
        const ConfigTab = ({ data, updateData }) => {
            const [newRole, setNewRole] = useState({ name: '', reduction: 0 });
            const [editingId, setEditingId] = useState(null);
            const [editRole, setEditRole] = useState(null);

            const handleAddRole = () => {
                if (!newRole.name) return;
                const role = { id: Date.now().toString(), ...newRole };
                updateData({ roles: [...data.roles, role] });
                setNewRole({ name: '', reduction: 0 });
            };

            const handleSaveEdit = () => {
                if (editRole) {
                    updateData({ roles: data.roles.map(r => r.id === editRole.id ? editRole : r) });
                    setEditingId(null);
                    setEditRole(null);
                }
            };

            return React.createElement('div', { className: "p-6" },
                React.createElement('div', { className: "mb-8" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, 'Cấu hình Hệ thống'),
                    React.createElement('div', { className: "bg-white border border-blue-200 p-6 rounded-xl shadow-sm max-w-2xl" },
                        React.createElement('label', { className: "block text-sm font-bold text-gray-700 mb-2" }, 'Định mức chuẩn toàn trường (Tiết/Tuần)'),
                        React.createElement('div', { className: "flex items-center gap-4" },
                            React.createElement('input', {
                                type: "number",
                                value: data.standardQuota,
                                onChange: (e) => updateData({ standardQuota: parseInt(e.target.value) || 0 }),
                                className: "w-28 px-4 py-2 text-lg font-bold text-blue-700 bg-white border-2 border-blue-100 rounded-lg outline-none focus:border-blue-500 shadow-inner"
                            }),
                            React.createElement('span', { className: "text-gray-500 text-sm italic" }, 'Mặc định THCS là 19 tiết.')
                        )
                    )
                ),
                React.createElement('div', null,
                    React.createElement('h3', { className: "text-xl font-semibold text-gray-800 mb-4" }, 'Chức vụ & Giảm trừ'),
                    React.createElement('div', { className: "overflow-x-auto rounded-xl border border-gray-200" },
                        React.createElement('table', { className: "w-full text-left" },
                            React.createElement('thead', { className: "bg-gray-100" },
                                React.createElement('tr', null,
                                    React.createElement('th', { className: "px-6 py-4 font-bold" }, 'Tên Chức vụ'),
                                    React.createElement('th', { className: "px-6 py-4 font-bold" }, 'Số tiết giảm'),
                                    React.createElement('th', { className: "px-6 py-4 font-bold text-right" }, 'Thao tác')
                                )
                            ),
                            React.createElement('tbody', null,
                                ...data.roles.map(role =>
                                    React.createElement('tr', { key: role.id, className: "border-b hover:bg-blue-50/30" },
                                        React.createElement('td', { className: "px-6 py-4" },
                                            editingId === role.id ?
                                                React.createElement('input', {
                                                    className: "w-full p-2 border rounded",
                                                    value: editRole?.name,
                                                    onChange: e => setEditRole({ ...editRole, name: e.target.value })
                                                }) :
                                                React.createElement('span', { className: "font-semibold" }, role.name)
                                        ),
                                        React.createElement('td', { className: "px-6 py-4" },
                                            editingId === role.id ?
                                                React.createElement('input', {
                                                    type: "number",
                                                    className: "w-20 p-2 border rounded",
                                                    value: editRole?.reduction,
                                                    onChange: e => setEditRole({ ...editRole, reduction: parseInt(e.target.value) || 0 })
                                                }) :
                                                React.createElement('span', null, role.reduction + ' tiết')
                                        ),
                                        React.createElement('td', { className: "px-6 py-4 text-right" },
                                            editingId === role.id ?
                                                React.createElement('div', { className: "flex justify-end gap-2" },
                                                    React.createElement('button', {
                                                        onClick: handleSaveEdit,
                                                        className: "p-2 bg-green-500 text-white rounded"
                                                    }, React.createElement(Check, { size: 18 })),
                                                    React.createElement('button', {
                                                        onClick: () => setEditingId(null),
                                                        className: "p-2 bg-gray-200 rounded"
                                                    }, React.createElement(X, { size: 18 }))
                                                ) :
                                                React.createElement('div', { className: "flex justify-end gap-2" },
                                                    React.createElement('button', {
                                                        onClick: () => { setEditingId(role.id); setEditRole({ ...role }); },
                                                        className: "text-blue-600"
                                                    }, React.createElement(Edit3, { size: 18 })),
                                                    React.createElement('button', {
                                                        onClick: () => updateData({ roles: data.roles.filter(r => r.id !== role.id) }),
                                                        className: "text-red-500"
                                                    }, React.createElement(Trash2, { size: 18 }))
                                                )
                                        )
                                    )
                                ),
                                React.createElement('tr', { className: "bg-blue-50/50" },
                                    React.createElement('td', { className: "px-6 py-4" },
                                        React.createElement('input', {
                                            placeholder: "Tên chức vụ mới...",
                                            className: "w-full p-2 border rounded",
                                            value: newRole.name,
                                            onChange: e => setNewRole({ ...newRole, name: e.target.value })
                                        })
                                    ),
                                    React.createElement('td', { className: "px-6 py-4" },
                                        React.createElement('input', {
                                            type: "number",
                                            className: "w-20 p-2 border rounded",
                                            value: newRole.reduction,
                                            onChange: e => setNewRole({ ...newRole, reduction: parseInt(e.target.value) || 0 })
                                        })
                                    ),
                                    React.createElement('td', { className: "px-6 py-4 text-right" },
                                        React.createElement('button', {
                                            onClick: handleAddRole,
                                            className: "bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2 ml-auto"
                                        }, React.createElement(Plus, { size: 18 }), ' Thêm')
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        // 2. TeacherTab
        const TeacherTab = ({ data, updateData }) => {
            const fileInputRef = useRef(null);
            const calculateActualQuota = (teacherRoles) => {
                const totalReduction = teacherRoles.reduce((sum, roleName) => {
                    const role = data.roles.find(r => r.name.toLowerCase().trim() === roleName.toLowerCase().trim());
                    return sum + (role ? role.reduction : 0);
                }, 0);
                return Math.max(0, data.standardQuota - totalReduction);
            };

            const handleExcelImport = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const isOverwrite = confirm("Ghi đè hoàn toàn danh sách cũ?");
                const reader = new FileReader();
                reader.onload = (event) => {
                    const bstr = event.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws);
                    const newTeachers = rows.map((row, idx) => {
                        const findVal = (ks) => {
                            const k = Object.keys(row).find(x => ks.includes(x.toLowerCase().trim()));
                            return k ? row[k] : '';
                        };
                        return {
                            id: (Date.now() + idx).toString(),
                            name: findVal(['tengv', 'ho ten', 'họ tên', 'tên gv']) || 'Không tên',
                            roles: (findVal(['chucvu', 'chức vụ'])?.toString() || '').split(',').map(s => s.trim()).filter(s => s),
                            subjects: findVal(['monday', 'môn dạy']) || '',
                            classes: findVal(['caclopday', 'lớp dạy']) || '',
                            assignedPeriods: parseFloat(findVal(['dinhmuttietmon', 'tiết tkb', 'số tiết'])) || 0
                        };
                    });
                    updateData({ teachers: isOverwrite ? newTeachers : [...data.teachers, ...newTeachers] });
                };
                reader.readAsBinaryString(file);
            };

            return React.createElement('div', { className: "p-6" },
                React.createElement('div', { className: "flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6" },
                    React.createElement('h2', { className: "text-2xl font-black" }, 'Phân công & Định mức'),
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('input', { type: "file", ref: fileInputRef, className: "hidden", onChange: handleExcelImport }),
                        React.createElement('button', {
                            onClick: () => fileInputRef.current.click(),
                            className: "bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold"
                        }, React.createElement(FileUp, { size: 20 }), ' Nhập Excel')
                    )
                ),
                React.createElement('div', { className: "overflow-x-auto border rounded-2xl shadow-sm" },
                    React.createElement('table', { className: "w-full text-left" },
                        React.createElement('thead', { className: "bg-gray-50 border-b" },
                            React.createElement('tr', null,
                                React.createElement('th', { className: "px-6 py-4 text-[10px] uppercase font-black text-gray-400" }, 'Họ tên / Môn'),
                                React.createElement('th', { className: "px-6 py-4 text-[10px] uppercase font-black text-gray-400 text-center" }, 'Định mức'),
                                React.createElement('th', { className: "px-6 py-4 text-[10px] uppercase font-black text-gray-400 text-center" }, 'Tiết TKB'),
                                React.createElement('th', { className: "px-6 py-4 text-right" })
                            )
                        ),
                        React.createElement('tbody', null,
                            data.teachers.length === 0 ?
                                React.createElement('tr', null,
                                    React.createElement('td', { colSpan: 4, className: "p-10 text-center text-gray-400 italic" }, 'Chưa có giáo viên.')
                                ) :
                                data.teachers.map(t =>
                                    React.createElement('tr', { key: t.id, className: "border-b hover:bg-blue-50/20" },
                                        React.createElement('td', { className: "px-6 py-4" },
                                            React.createElement('div', { className: "font-bold" }, t.name),
                                            React.createElement('div', { className: "text-[10px] text-gray-400 font-bold uppercase" }, t.subjects + ' | ' + t.classes)
                                        ),
                                        React.createElement('td', { className: "px-6 py-4 text-center font-black text-gray-600" }, calculateActualQuota(t.roles)),
                                        React.createElement('td', { className: "px-6 py-4" },
                                            React.createElement('input', {
                                                type: "number",
                                                step: "0.5",
                                                className: "w-20 mx-auto block text-center p-2 bg-blue-50 border rounded-lg font-bold text-blue-700",
                                                value: t.assignedPeriods,
                                                onChange: e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    updateData({ teachers: data.teachers.map(x => x.id === t.id ? { ...x, assignedPeriods: val } : x) });
                                                }
                                            })
                                        ),
                                        React.createElement('td', { className: "px-6 py-4 text-right" },
                                            React.createElement('button', {
                                                onClick: () => updateData({ teachers: data.teachers.filter(x => x.id !== t.id) }),
                                                className: "text-red-300 hover:text-red-600"
                                            }, React.createElement(Trash2, { size: 18 }))
                                        )
                                    )
                                )
                        )
                    )
                )
            );
        };

        // 3. WeeklyTab
        const WeeklyTab = ({ data, updateData }) => {
            const [currentWeek, setCurrentWeek] = useState(1);
            const [editingLogs, setEditingLogs] = useState({});
            const [isDirty, setIsDirty] = useState(false);

            useEffect(() => {
                setEditingLogs(data.weeklyData[currentWeek] || {});
                setIsDirty(false);
            }, [currentWeek, data.weeklyData]);

            const save = () => {
                updateData({ weeklyData: { ...data.weeklyData, [currentWeek]: editingLogs } });
                setIsDirty(false);
                alert("Lưu thành công!");
            };

            return React.createElement('div', { className: "p-6" },
                React.createElement('div', { className: "flex justify-between items-center mb-8" },
                    React.createElement('h2', { className: "text-2xl font-black" }, 'Nhập Tiết Thực dạy'),
                    React.createElement('div', { className: "flex items-center gap-4 bg-white border-2 border-blue-100 p-3 rounded-2xl shadow-sm" },
                        React.createElement('button', { onClick: () => setCurrentWeek(Math.max(1, currentWeek - 1)) }, React.createElement(ChevronLeft, null)),
                        React.createElement('span', { className: "text-xl font-black" }, 'Tuần ' + currentWeek),
                        React.createElement('button', { onClick: () => setCurrentWeek(currentWeek + 1) }, React.createElement(ChevronRight, null))
                    )
                ),
                React.createElement('div', { className: "flex gap-2 mb-6" },
                    React.createElement('button', {
                        onClick: () => {
                            const copy = {};
                            data.teachers.forEach(t => copy[t.id] = t.assignedPeriods);
                            setEditingLogs(copy);
                            setIsDirty(true);
                        },
                        className: "bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold"
                    }, 'Lấy từ TKB'),
                    React.createElement('button', {
                        onClick: save,
                        disabled: !isDirty,
                        className: `px-6 py-2 rounded-lg font-bold ml-auto ${isDirty ? 'bg-green-600 text-white shadow-lg' : 'bg-gray-100 text-gray-300'}`
                    }, 'Lưu Tuần ' + currentWeek)
                ),
                React.createElement('div', { className: "overflow-x-auto border rounded-2xl" },
                    React.createElement('table', { className: "w-full text-left" },
                        React.createElement('thead', { className: "bg-gray-50 border-b" },
                            React.createElement('tr', null,
                                React.createElement('th', { className: "px-6 py-4 font-black text-gray-400 uppercase text-[10px]" }, 'Giáo viên'),
                                React.createElement('th', { className: "px-6 py-4 font-black text-gray-400 uppercase text-[10px] text-center" }, 'TKB'),
                                React.createElement('th', { className: "px-6 py-4 font-black text-blue-600 uppercase text-[10px] text-center" }, 'Thực dạy')
                            )
                        ),
                        React.createElement('tbody', null,
                            data.teachers.map(t =>
                                React.createElement('tr', { key: t.id, className: "border-b" },
                                    React.createElement('td', { className: "px-6 py-4" },
                                        React.createElement('div', { className: "font-bold" }, t.name),
                                        React.createElement('div', { className: "text-[10px] text-gray-400" }, t.subjects)
                                    ),
                                    React.createElement('td', { className: "px-6 py-4 text-center font-bold text-gray-300" }, t.assignedPeriods),
                                    React.createElement('td', { className: "px-6 py-4" },
                                        React.createElement('input', {
                                            type: "number",
                                            step: "0.5",
                                            className: "w-24 mx-auto block text-center p-3 bg-blue-50 border-2 border-blue-100 rounded-xl font-black text-2xl text-blue-700 focus:border-blue-500",
                                            value: editingLogs[t.id] ?? 0,
                                            onChange: e => {
                                                setEditingLogs({ ...editingLogs, [t.id]: parseFloat(e.target.value) || 0 });
                                                setIsDirty(true);
                                            }
                                        })
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        // 4. ReportTab
        const ReportTab = ({ data }) => {
            const [startWeek, setStartWeek] = useState(1);
            const [endWeek, setEndWeek] = useState(() => {
                const ws = Object.keys(data.weeklyData).map(Number);
                return ws.length > 0 ? Math.max(...ws) : 1;
            });

            const stats = useMemo(() => {
                const weeks = endWeek - startWeek + 1;
                if (weeks <= 0) return [];
                return data.teachers.map(t => {
                    const quotaPerWeek = data.standardQuota - (t.roles.reduce((s, rN) => s + (data.roles.find(r => r.name === rN)?.reduction || 0), 0));
                    let total = 0;
                    for (let w = startWeek; w <= endWeek; w++) total += (data.weeklyData[w]?.[t.id] || 0);
                    return { ...t, totalActual: total, totalQuota: quotaPerWeek * weeks, balance: total - (quotaPerWeek * weeks) };
                });
            }, [data, startWeek, endWeek]);

            return React.createElement('div', { className: "p-6" },
                React.createElement('div', { className: "flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 mb-8" },
                    React.createElement('h2', { className: "text-3xl font-black flex items-center gap-2" },
                        React.createElement(LayoutDashboard, { className: "text-blue-600" }),
                        ' Báo cáo'
                    ),
                    React.createElement('div', { className: "flex gap-3 bg-gray-900 p-2 rounded-2xl" },
                        React.createElement('input', {
                            type: "number",
                            className: "w-16 p-1 rounded text-center font-bold",
                            value: startWeek,
                            onChange: e => setStartWeek(parseInt(e.target.value) || 1)
                        }),
                        React.createElement('span', { className: "text-white font-bold" }, 'đến'),
                        React.createElement('input', {
                            type: "number",
                            className: "w-16 p-1 rounded text-center font-bold",
                            value: endWeek,
                            onChange: e => setEndWeek(parseInt(e.target.value) || 1)
                        })
                    )
                ),
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-6 mb-10" },
                    React.createElement('div', { className: "bg-blue-600 p-6 rounded-3xl text-white shadow-xl" },
                        React.createElement('div', { className: "text-sm font-bold opacity-80 uppercase" }, 'Tổng tiết dạy'),
                        React.createElement('div', { className: "text-4xl font-black" }, stats.reduce((a, b) => a + b.totalActual, 0).toFixed(1))
                    ),
                    React.createElement('div', { className: "bg-green-500 p-6 rounded-3xl text-white shadow-xl" },
                        React.createElement('div', { className: "text-sm font-bold opacity-80 uppercase" }, 'Dôi dư (Thừa)'),
                        React.createElement('div', { className: "text-4xl font-black" }, '+' + stats.reduce((a, b) => a + (b.balance > 0 ? b.balance : 0), 0).toFixed(1))
                    ),
                    React.createElement('div', { className: "bg-red-500 p-6 rounded-3xl text-white shadow-xl" },
                        React.createElement('div', { className: "text-sm font-bold opacity-80 uppercase" }, 'Thiếu hụt'),
                        React.createElement('div', { className: "text-4xl font-black" }, stats.reduce((a, b) => a + (b.balance < 0 ? b.balance : 0), 0).toFixed(1))
                    )
                ),
                React.createElement('div', { className: "overflow-x-auto border rounded-2xl" },
                    React.createElement('table', { className: "w-full text-left" },
                        React.createElement('thead', { className: "bg-gray-50 border-b" },
                            React.createElement('tr', null,
                                React.createElement('th', { className: "px-6 py-4 font-black uppercase text-[10px]" }, 'Giáo viên'),
                                React.createElement('th', { className: "px-6 py-4 font-black uppercase text-[10px] text-center" }, 'Định mức'),
                                React.createElement('th', { className: "px-6 py-4 font-black uppercase text-[10px] text-center" }, 'Thực dạy'),
                                React.createElement('th', { className: "px-6 py-4 font-black uppercase text-[10px] text-center" }, 'Chênh lệch')
                            )
                        ),
                        React.createElement('tbody', null,
                            stats.map(t =>
                                React.createElement('tr', { key: t.id, className: "border-b hover:bg-gray-50" },
                                    React.createElement('td', { className: "px-6 py-4 font-bold" }, t.name),
                                    React.createElement('td', { className: "px-6 py-4 text-center font-medium" }, t.totalQuota.toFixed(1)),
                                    React.createElement('td', { className: "px-6 py-4 text-center font-black text-blue-700" }, t.totalActual.toFixed(1)),
                                    React.createElement('td', { className: "px-6 py-4 text-center" },
                                        React.createElement('span', {
                                            className: `px-3 py-1 rounded-full font-black text-xs ${t.balance >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`
                                        }, t.balance > 0 ? `+${t.balance.toFixed(1)}` : t.balance.toFixed(1))
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        // 5. BackupTab
        const BackupTab = ({ data, updateData }) => {
            const exportData = () => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };
            return React.createElement('div', { className: "p-10 text-center" },
                React.createElement('h2', { className: "text-3xl font-black mb-8" }, 'Quản lý Dữ liệu'),
                React.createElement('div', { className: "flex flex-wrap justify-center gap-8" },
                    React.createElement('div', {
                        className: "bg-white p-8 rounded-3xl border-2 border-dashed border-blue-200 w-64 hover:border-blue-500 transition-all cursor-pointer",
                        onClick: exportData
                    },
                        React.createElement(Download, { className: "mx-auto mb-4 text-blue-600", size: 48 }),
                        React.createElement('div', { className: "font-black" }, 'Tải Sao lưu'),
                        React.createElement('div', { className: "text-xs text-gray-400 mt-2" }, 'L
