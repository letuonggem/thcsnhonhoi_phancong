
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Giảng dạy THCS Nhon Hoi - Single File</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        * { -webkit-overflow-scrolling: touch; }
        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
<script type="importmap">
{
  "imports": {
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "vite": "https://esm.sh/vite@^7.3.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@19.0.0';
        import ReactDOM from 'https://esm.sh/react-dom@19.0.0/client';
        import { 
            LayoutDashboard, Users, CalendarDays, FileText, Save, Settings, 
            HardDrive, Plus, Trash2, Edit3, Check, X, FileUp, Download, 
            Info, ChevronLeft, ChevronRight, ClipboardCheck, CheckCircle2, 
            Copy, RefreshCcw, FileDown, BookOpen, GraduationCap, TrendingUp, 
            CalendarRange, Upload, AlertTriangle, RefreshCw, ShieldCheck, Database 
        } from 'https://esm.sh/lucide-react';

        // --- CONSTANTS ---
        const STORAGE_KEY = 'thcs_teaching_mgmt_data';
        const DEFAULT_STANDARD_QUOTA = 19;
        const INITIAL_ROLES = [
            { id: '1', name: 'Tổ trưởng', reduction: 3 },
            { id: '2', name: 'Chủ nhiệm', reduction: 4 },
            { id: '3', name: 'Thư ký hội đồng', reduction: 2 },
            { id: '4', name: 'Tổ phó', reduction: 1 },
            { id: '5', name: 'Tổng phụ trách', reduction: 10 }
        ];

        // --- COMPONENTS ---

        // 1. ConfigTab
        const ConfigTab = ({ data, updateData }) => {
            const [newRole, setNewRole] = useState({ name: '', reduction: 0 });
            const [editingId, setEditingId] = useState(null);
            const [editRole, setEditRole] = useState(null);

            const handleAddRole = () => {
                if (!newRole.name) return;
                const role = { id: Date.now().toString(), ...newRole };
                updateData({ roles: [...data.roles, role] });
                setNewRole({ name: '', reduction: 0 });
            };

            const handleSaveEdit = () => {
                if (editRole) {
                    updateData({ roles: data.roles.map(r => r.id === editRole.id ? editRole : r) });
                    setEditingId(null);
                    setEditRole(null);
                }
            };

            return (
                <div className="p-6">
                    <div className="mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Cấu hình Hệ thống</h2>
                        <div className="bg-white border border-blue-200 p-6 rounded-xl shadow-sm max-w-2xl">
                            <label className="block text-sm font-bold text-gray-700 mb-2">Định mức chuẩn toàn trường (Tiết/Tuần)</label>
                            <div className="flex items-center gap-4">
                                <input
                                    type="number"
                                    value={data.standardQuota}
                                    onChange={(e) => updateData({ standardQuota: parseInt(e.target.value) || 0 })}
                                    className="w-28 px-4 py-2 text-lg font-bold text-blue-700 bg-white border-2 border-blue-100 rounded-lg outline-none focus:border-blue-500 shadow-inner"
                                />
                                <span className="text-gray-500 text-sm italic">Mặc định THCS là 19 tiết.</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">Chức vụ & Giảm trừ</h3>
                        <div className="overflow-x-auto rounded-xl border border-gray-200">
                            <table className="w-full text-left">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="px-6 py-4 font-bold">Tên Chức vụ</th>
                                        <th className="px-6 py-4 font-bold">Số tiết giảm</th>
                                        <th className="px-6 py-4 font-bold text-right">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.roles.map(role => (
                                        <tr key={role.id} className="border-b hover:bg-blue-50/30">
                                            <td className="px-6 py-4">
                                                {editingId === role.id ? (
                                                    <input className="w-full p-2 border rounded" value={editRole?.name} onChange={e => setEditRole({...editRole, name: e.target.value})} />
                                                ) : <span className="font-semibold">{role.name}</span>}
                                            </td>
                                            <td className="px-6 py-4">
                                                {editingId === role.id ? (
                                                    <input type="number" className="w-20 p-2 border rounded" value={editRole?.reduction} onChange={e => setEditRole({...editRole, reduction: parseInt(e.target.value)||0})} />
                                                ) : <span>{role.reduction} tiết</span>}
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                {editingId === role.id ? (
                                                    <div className="flex justify-end gap-2">
                                                        <button onClick={handleSaveEdit} className="p-2 bg-green-500 text-white rounded"><Check size={18}/></button>
                                                        <button onClick={() => setEditingId(null)} className="p-2 bg-gray-200 rounded"><X size={18}/></button>
                                                    </div>
                                                ) : (
                                                    <div className="flex justify-end gap-2">
                                                        <button onClick={() => {setEditingId(role.id); setEditRole({...role});}} className="text-blue-600"><Edit3 size={18}/></button>
                                                        <button onClick={() => updateData({roles: data.roles.filter(r => r.id !== role.id)})} className="text-red-500"><Trash2 size={18}/></button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                    <tr className="bg-blue-50/50">
                                        <td className="px-6 py-4"><input placeholder="Tên chức vụ mới..." className="w-full p-2 border rounded" value={newRole.name} onChange={e => setNewRole({...newRole, name: e.target.value})} /></td>
                                        <td className="px-6 py-4"><input type="number" className="w-20 p-2 border rounded" value={newRole.reduction} onChange={e => setNewRole({...newRole, reduction: parseInt(e.target.value)||0})} /></td>
                                        <td className="px-6 py-4 text-right"><button onClick={handleAddRole} className="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2 ml-auto"><Plus size={18}/> Thêm</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. TeacherTab
        const TeacherTab = ({ data, updateData }) => {
            const fileInputRef = useRef(null);
            const calculateActualQuota = (teacherRoles) => {
                const totalReduction = teacherRoles.reduce((sum, roleName) => {
                    const role = data.roles.find(r => r.name.toLowerCase().trim() === roleName.toLowerCase().trim());
                    return sum + (role ? role.reduction : 0);
                }, 0);
                return Math.max(0, data.standardQuota - totalReduction);
            };

            const handleExcelImport = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const isOverwrite = confirm("Ghi đè hoàn toàn danh sách cũ?");
                const reader = new FileReader();
                reader.onload = (event) => {
                    const bstr = event.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws);
                    const newTeachers = rows.map((row, idx) => {
                        const findVal = (ks) => {
                            const k = Object.keys(row).find(x => ks.includes(x.toLowerCase().trim()));
                            return k ? row[k] : '';
                        };
                        return {
                            id: (Date.now() + idx).toString(),
                            name: findVal(['tengv', 'ho ten', 'họ tên', 'tên gv']) || 'Không tên',
                            roles: (findVal(['chucvu', 'chức vụ'])?.toString() || '').split(',').map(s => s.trim()).filter(s => s),
                            subjects: findVal(['monday', 'môn dạy']) || '',
                            classes: findVal(['caclopday', 'lớp dạy']) || '',
                            assignedPeriods: parseFloat(findVal(['dinhmuttietmon', 'tiết tkb', 'số tiết'])) || 0
                        };
                    });
                    updateData({ teachers: isOverwrite ? newTeachers : [...data.teachers, ...newTeachers] });
                };
                reader.readAsBinaryString(file);
            };

            return (
                <div className="p-6">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h2 className="text-2xl font-black">Phân công & Định mức</h2>
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} className="hidden" onChange={handleExcelImport} />
                            <button onClick={() => fileInputRef.current.click()} className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold"><FileUp size={20}/> Nhập Excel</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto border rounded-2xl shadow-sm">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="px-6 py-4 text-[10px] uppercase font-black text-gray-400">Họ tên / Môn</th>
                                    <th className="px-6 py-4 text-[10px] uppercase font-black text-gray-400 text-center">Định mức</th>
                                    <th className="px-6 py-4 text-[10px] uppercase font-black text-gray-400 text-center">Tiết TKB</th>
                                    <th className="px-6 py-4 text-right"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.teachers.map(t => (
                                    <tr key={t.id} className="border-b hover:bg-blue-50/20">
                                        <td className="px-6 py-4">
                                            <div className="font-bold">{t.name}</div>
                                            <div className="text-[10px] text-gray-400 font-bold uppercase">{t.subjects} | {t.classes}</div>
                                        </td>
                                        <td className="px-6 py-4 text-center font-black text-gray-600">{calculateActualQuota(t.roles)}</td>
                                        <td className="px-6 py-4">
                                            <input 
                                                type="number" step="0.5" 
                                                className="w-20 mx-auto block text-center p-2 bg-blue-50 border rounded-lg font-bold text-blue-700" 
                                                value={t.assignedPeriods} 
                                                onChange={e => {
                                                    const val = parseFloat(e.target.value) || 0;
                                                    updateData({ teachers: data.teachers.map(x => x.id === t.id ? {...x, assignedPeriods: val} : x)});
                                                }}
                                            />
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            <button onClick={() => updateData({ teachers: data.teachers.filter(x => x.id !== t.id)})} className="text-red-300 hover:text-red-600"><Trash2 size={18}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {data.teachers.length === 0 && <div className="p-10 text-center text-gray-400 italic">Chưa có giáo viên.</div>}
                    </div>
                </div>
            );
        };

        // 3. WeeklyTab
        const WeeklyTab = ({ data, updateData }) => {
            const [currentWeek, setCurrentWeek] = useState(1);
            const [editingLogs, setEditingLogs] = useState({});
            const [isDirty, setIsDirty] = useState(false);

            useEffect(() => {
                setEditingLogs(data.weeklyData[currentWeek] || {});
                setIsDirty(false);
            }, [currentWeek, data.weeklyData]);

            const save = () => {
                updateData({ weeklyData: { ...data.weeklyData, [currentWeek]: editingLogs } });
                setIsDirty(false);
                alert("Lưu thành công!");
            };

            return (
                <div className="p-6">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-2xl font-black">Nhập Tiết Thực dạy</h2>
                        <div className="flex items-center gap-4 bg-white border-2 border-blue-100 p-3 rounded-2xl shadow-sm">
                            <button onClick={() => setCurrentWeek(Math.max(1, currentWeek - 1))}><ChevronLeft/></button>
                            <span className="text-xl font-black">Tuần {currentWeek}</span>
                            <button onClick={() => setCurrentWeek(currentWeek + 1)}><ChevronRight/></button>
                        </div>
                    </div>
                    <div className="flex gap-2 mb-6">
                        <button onClick={() => {
                            const copy = {}; data.teachers.forEach(t => copy[t.id] = t.assignedPeriods);
                            setEditingLogs(copy); setIsDirty(true);
                        }} className="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold">Lấy từ TKB</button>
                        <button onClick={save} disabled={!isDirty} className={`px-6 py-2 rounded-lg font-bold ml-auto ${isDirty ? 'bg-green-600 text-white shadow-lg' : 'bg-gray-100 text-gray-300'}`}>Lưu Tuần {currentWeek}</button>
                    </div>
                    <div className="overflow-x-auto border rounded-2xl">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="px-6 py-4 font-black text-gray-400 uppercase text-[10px]">Giáo viên</th>
                                    <th className="px-6 py-4 font-black text-gray-400 uppercase text-[10px] text-center">TKB</th>
                                    <th className="px-6 py-4 font-black text-blue-600 uppercase text-[10px] text-center">Thực dạy</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.teachers.map(t => (
                                    <tr key={t.id} className="border-b">
                                        <td className="px-6 py-4">
                                            <div className="font-bold">{t.name}</div>
                                            <div className="text-[10px] text-gray-400">{t.subjects}</div>
                                        </td>
                                        <td className="px-6 py-4 text-center font-bold text-gray-300">{t.assignedPeriods}</td>
                                        <td className="px-6 py-4">
                                            <input 
                                                type="number" step="0.5" 
                                                className="w-24 mx-auto block text-center p-3 bg-blue-50 border-2 border-blue-100 rounded-xl font-black text-2xl text-blue-700 focus:border-blue-500"
                                                value={editingLogs[t.id] ?? 0}
                                                onChange={e => { setEditingLogs({...editingLogs, [t.id]: parseFloat(e.target.value)||0}); setIsDirty(true); }}
                                            />
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 4. ReportTab
        const ReportTab = ({ data }) => {
            const [startWeek, setStartWeek] = useState(1);
            const [endWeek, setEndWeek] = useState(() => {
                const ws = Object.keys(data.weeklyData).map(Number);
                return ws.length > 0 ? Math.max(...ws) : 1;
            });

            const stats = useMemo(() => {
                const weeks = endWeek - startWeek + 1;
                if (weeks <= 0) return [];
                return data.teachers.map(t => {
                    const quotaPerWeek = data.standardQuota - (t.roles.reduce((s, rN) => s + (data.roles.find(r => r.name === rN)?.reduction || 0), 0));
                    let total = 0;
                    for (let w = startWeek; w <= endWeek; w++) total += (data.weeklyData[w]?.[t.id] || 0);
                    return { ...t, totalActual: total, totalQuota: quotaPerWeek * weeks, balance: total - (quotaPerWeek * weeks) };
                });
            }, [data, startWeek, endWeek]);

            return (
                <div className="p-6">
                    <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 mb-8">
                        <h2 className="text-3xl font-black flex items-center gap-2"><LayoutDashboard className="text-blue-600"/> Báo cáo</h2>
                        <div className="flex gap-3 bg-gray-900 p-2 rounded-2xl">
                            <input type="number" className="w-16 p-1 rounded text-center font-bold" value={startWeek} onChange={e => setStartWeek(parseInt(e.target.value)||1)} />
                            <span className="text-white font-bold">đến</span>
                            <input type="number" className="w-16 p-1 rounded text-center font-bold" value={endWeek} onChange={e => setEndWeek(parseInt(e.target.value)||1)} />
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div className="bg-blue-600 p-6 rounded-3xl text-white shadow-xl">
                            <div className="text-sm font-bold opacity-80 uppercase">Tổng tiết dạy</div>
                            <div className="text-4xl font-black">{stats.reduce((a, b) => a + b.totalActual, 0).toFixed(1)}</div>
                        </div>
                        <div className="bg-green-500 p-6 rounded-3xl text-white shadow-xl">
                            <div className="text-sm font-bold opacity-80 uppercase">Dôi dư (Thừa)</div>
                            <div className="text-4xl font-black">+{stats.reduce((a, b) => a + (b.balance > 0 ? b.balance : 0), 0).toFixed(1)}</div>
                        </div>
                        <div className="bg-red-500 p-6 rounded-3xl text-white shadow-xl">
                            <div className="text-sm font-bold opacity-80 uppercase">Thiếu hụt</div>
                            <div className="text-4xl font-black">{stats.reduce((a, b) => a + (b.balance < 0 ? b.balance : 0), 0).toFixed(1)}</div>
                        </div>
                    </div>
                    <div className="overflow-x-auto border rounded-2xl">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b">
                                <tr>
                                    <th className="px-6 py-4 font-black uppercase text-[10px]">Giáo viên</th>
                                    <th className="px-6 py-4 font-black uppercase text-[10px] text-center">Định mức</th>
                                    <th className="px-6 py-4 font-black uppercase text-[10px] text-center">Thực dạy</th>
                                    <th className="px-6 py-4 font-black uppercase text-[10px] text-center">Chênh lệch</th>
                                </tr>
                            </thead>
                            <tbody>
                                {stats.map(t => (
                                    <tr key={t.id} className="border-b hover:bg-gray-50">
                                        <td className="px-6 py-4 font-bold">{t.name}</td>
                                        <td className="px-6 py-4 text-center font-medium">{t.totalQuota.toFixed(1)}</td>
                                        <td className="px-6 py-4 text-center font-black text-blue-700">{t.totalActual.toFixed(1)}</td>
                                        <td className="px-6 py-4 text-center">
                                            <span className={`px-3 py-1 rounded-full font-black text-xs ${t.balance >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {t.balance > 0 ? `+${t.balance.toFixed(1)}` : t.balance.toFixed(1)}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 5. BackupTab
        const BackupTab = ({ data, updateData }) => {
            const exportData = () => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };
            return (
                <div className="p-10 text-center">
                    <h2 className="text-3xl font-black mb-8">Quản lý Dữ liệu</h2>
                    <div className="flex flex-wrap justify-center gap-8">
                        <div className="bg-white p-8 rounded-3xl border-2 border-dashed border-blue-200 w-64 hover:border-blue-500 transition-all cursor-pointer" onClick={exportData}>
                            <Download className="mx-auto mb-4 text-blue-600" size={48}/>
                            <div className="font-black">Tải Sao lưu</div>
                            <div className="text-xs text-gray-400 mt-2">Lưu file .json vào máy tính</div>
                        </div>
                        <div className="bg-white p-8 rounded-3xl border-2 border-dashed border-red-100 w-64 hover:border-red-500 transition-all cursor-pointer" onClick={() => confirm("Xóa sạch dữ liệu?") && (localStorage.clear(), location.reload())}>
                            <RefreshCw className="mx-auto mb-4 text-red-500" size={48}/>
                            <div className="font-black">Reset Ứng dụng</div>
                            <div className="text-xs text-gray-400 mt-2">Dọn dẹp bộ nhớ trình duyệt</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('teachers');
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : { standardQuota: 19, roles: INITIAL_ROLES, teachers: [], weeklyData: {} };
            });

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }, [data]);

            const updateData = (newData) => setData(prev => ({ ...prev, ...newData }));

            const nav = [
                { id: 'config', label: 'Cấu hình', icon: Settings },
                { id: 'teachers', label: 'Phân công', icon: Users },
                { id: 'weekly', label: 'Nhập Tuần', icon: CalendarDays },
                { id: 'reports', label: 'Báo cáo', icon: FileText },
                { id: 'backup', label: 'Sao lưu', icon: Save },
            ];

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-blue-800 text-white shadow-xl sticky top-0 z-50 p-4">
                        <div className="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-white p-2 rounded-xl text-blue-800"><LayoutDashboard/></div>
                                <h1 className="text-xl font-black">QUẢN LÝ GIẢNG DẠY THCS</h1>
                            </div>
                            <nav className="flex gap-1">
                                {nav.map(item => (
                                    <button 
                                        key={item.id} onClick={() => setActiveTab(item.id)}
                                        className={`px-4 py-2 rounded-xl transition-all text-sm font-bold flex items-center gap-2 ${activeTab === item.id ? 'bg-white text-blue-800 shadow-lg' : 'hover:bg-blue-700/50'}`}
                                    >
                                        <item.icon size={16}/> <span className="hidden sm:inline">{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </header>
                    <main className="flex-1 container mx-auto p-4 md:p-8">
                        <div className="bg-white rounded-3xl shadow-2xl border min-h-[600px] overflow-hidden">
                            {activeTab === 'config' && <ConfigTab data={data} updateData={updateData} />}
                            {activeTab === 'teachers' && <TeacherTab data={data} updateData={updateData} />}
                            {activeTab === 'weekly' && <WeeklyTab data={data} updateData={updateData} />}
                            {activeTab === 'reports' && <ReportTab data={data} />}
                            {activeTab === 'backup' && <BackupTab data={data} updateData={updateData} />}
                        </div>
                    </main>
                    <footer className="p-6 text-center text-gray-400 text-xs font-bold border-t">
                        Sản phẩm dành cho giáo viên - Toàn bộ dữ liệu lưu trữ tại trình duyệt của bạn.
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
